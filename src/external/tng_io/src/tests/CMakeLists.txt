if(TNG_BUILD_COMPRESSION_TESTS)
  add_subdirectory(compression)
endif()

add_definitions(-DTNG_EXAMPLE_FILES_DIR="${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests/example_files/") # Directory where to find input test files and save output files.

if(TNG_BUILD_TEST)
    #add googletest
    Include(GoogleTest)
    add_subdirectory(googletest)
    enable_testing()
    include_directories(${gtest_SOURCE_DIR}/include ${gtest_SOURCE_DIR})
    
    add_executable(tng_testing tng_io_testing.c)
    target_link_libraries(tng_testing tng_io)
    if(UNIX)
        target_link_libraries(tng_testing m)
    endif()

    if(HAVE_INTTYPES_H)
      set_property(TARGET tng_testing APPEND PROPERTY COMPILE_DEFINITIONS USE_STD_INTTYPES_H=1)
    endif()

    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/../../example_files DESTINATION ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests/)

    set_property(TARGET tng_testing PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests)

    add_executable(tng_io_read_high_level tng_io_read_high_level.cpp)
    target_link_libraries(tng_io_read_high_level tng_io)
    if(UNIX)
        target_link_libraries(tng_io_read_high_level m)
    endif()
    if(HAVE_INTTYPES_H)
      set_property(TARGET tng_io_read_high_level APPEND PROPERTY COMPILE_DEFINITIONS USE_STD_INTTYPES_H=1)
    endif()
    set_property(TARGET tng_io_read_high_level PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests)

    add_executable(regtest regression_gtest.cpp)
    target_link_libraries(regtest tng_io)
    target_link_libraries(regtest gtest gtest_main)
    gtest_discover_tests(regtest WORKING_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests)
    if(UNIX)
        target_link_libraries(regtest m)
    endif()
    if(HAVE_INTTYPES_H)
      set_property(TARGET regtest APPEND PROPERTY COMPILE_DEFINITIONS USE_STD_INTTYPES_H=1)
    endif()
    set_property(TARGET regtest PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/tests)
    
endif()

if(TNG_BUILD_EXAMPLES)
    find_package(OpenMP)
    if(OPENMP_FOUND)
        set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${OpenMP_EXE_LINKER_FLAGS}")

        add_executable(md_openmp md_openmp.c)
        target_link_libraries(md_openmp tng_io ${OpenMP_LIBS})
        if(UNIX)
            target_link_libraries(md_openmp m)
        endif()
        set_property(TARGET md_openmp PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)
        set_property(TARGET md_openmp APPEND PROPERTY COMPILE_DEFINITIONS TNG_BUILD_OPENMP_EXAMPLES)


        add_executable(md_openmp_util md_openmp_util.c)
        target_link_libraries(md_openmp_util tng_io ${OpenMP_LIBS})
        if(UNIX)
            target_link_libraries(md_openmp_util m)
        endif()
        set_property(TARGET md_openmp_util PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)
        set_property(TARGET md_openmp_util APPEND PROPERTY COMPILE_DEFINITIONS TNG_BUILD_OPENMP_EXAMPLES)

        add_executable(tng_parallel_read tng_parallel_read.c)
        target_link_libraries(tng_parallel_read tng_io)
        if(UNIX)
            target_link_libraries(tng_parallel_read m)
        endif()
        set_property(TARGET tng_parallel_read PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)
        set_property(TARGET tng_parallel_read APPEND PROPERTY COMPILE_DEFINITIONS TNG_BUILD_OPENMP_EXAMPLES)
    endif()

    add_executable(tng_io_read_pos tng_io_read_pos.c)
    target_link_libraries(tng_io_read_pos tng_io)
    if(UNIX)
        target_link_libraries(tng_io_read_pos m)
    endif()
    if(HAVE_INTTYPES_H)
      set_property(TARGET tng_io_read_pos APPEND PROPERTY COMPILE_DEFINITIONS USE_STD_INTTYPES_H=1)
    endif()
    set_property(TARGET tng_io_read_pos PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)

    add_executable(tng_io_read_pos_util tng_io_read_pos_util.c)
    target_link_libraries(tng_io_read_pos_util tng_io)
    if(UNIX)
        target_link_libraries(tng_io_read_pos_util m)
    endif()
    if(HAVE_INTTYPES_H)
      set_property(TARGET tng_io_read_pos_util APPEND PROPERTY COMPILE_DEFINITIONS USE_STD_INTTYPES_H=1)
    endif()
    set_property(TARGET tng_io_read_pos_util PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)

    if(TNG_BUILD_FORTRAN)
        # This does not work due to a bug in CMake. Remove lines below if no fortran compiler is found.
        enable_language(Fortran OPTIONAL)
        if(${CMAKE_Fortran_COMPILER_WORKS})
            get_filename_component (Fortran_COMPILER_NAME ${CMAKE_Fortran_COMPILER} NAME)
            if (Fortran_COMPILER_NAME STREQUAL "gfortran")
                set(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -fcray-pointer ${OpenMP_C_FLAGS} -std=legacy -cpp -ffixed-line-length-none")
            endif()
            if(OPENMP_FOUND)
                add_executable(md_openmp_f md_openmp.f)
                target_link_libraries(md_openmp_f tng_io ${OpenMP_LIBS})
                set_property(TARGET md_openmp_f PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/examples)
            endif()
        endif()
    endif()
endif()
