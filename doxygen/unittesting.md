Unit testing {#page_unittesting}
============

Finding, building and running
=============================

As described in \ref page_codelayout, `src/gromacs/` is divided into modules,
each corresponding to a subdirectory.  If available, unit tests for that module
can be found in a `tests/` subdirectory under the top-level module directory.
Typically, tests for code in _file_.h in the module is in a corresponding
`tests/`<em>file</em>`.cpp`.  Not all files have corresponding tests, as it may not
make sense to test that individual file in isolation.  Focus of the tests is on
functionality exposed outside the module.  Some of the tests, in particular for
higher-level modules, are more like integration tests, and test the
functionality of multiple modules.
Shared code used to implement the tests is in `src/external/gmock-1.7.0/` and
`src/testutils/` (see below).

The tests are built if `BUILD_TESTING=ON` (the default) and
`GMX_BUILD_UNITTESTS=ON` (the default if `libxml2` is available) in CMake.
Each module produces a separate unit test binary (_module_`-test`) under
`bin/`, which can execute all the tests for that module.

The tests can be executed in a few different ways:
 - `make test`: This runs all the tests using CTest.
   If some of the tests fail, this only prints basic summary information
   (only a pass/fail status for each test binary).
   You can execute the failing test binaries individually to get more
   information on the failure.
   Note that `make test` does not rebuild the test binaries if you have changed
   the source code, so you need to separately run `make` or `make tests`.
   The latter only builds the test binaries and their dependencies.
 - `make check`: This behaves the same as `make test`, with a few exceptions:
    1. Test binaries are rebuilt if they are outdated before the tests are run.
    2. If a test fails, the output of the test binary is shown.
    3. It also runs the regression tests if CMake has been told where to find
       them.
 - Directly executing a test binary.  This provides the most useful output for
   diagnosing failures, and allows debugging the tests.  It is possible to
   control which tests are run using command line options.  Execute the binary
   with `-h` to get additional information.

When executed using CTest, the tests produce XML output in
`Testing/Temporary/`, containing the result of each test as well as failure
messages.  This XML is used by Jenkins for reporting the test status for
individual tests.  Note that if a test crashes or fails because of an assert or
a gmx_fatal() call, no XML is produced for the binary, and Jenkins does not
report anything for the test binary.  The actual error is only visible in the
console output.

Unit testing framework
======================

The tests are written using [Google Test][], which provides a framework for
writing unit tests and compiling them into a test binary.  Most of the command
line options provided by the test binaries are implemented by Google Test.  See
[Google Test Primer][] for an introduction.
Some tests also use [Google Mock][], which provides a framework for creating
mock implementations of C++ classes.  Both components are included in the
source tree under `src/external/gmock-1.7.0/`, and are compiled as part of the
unit test build.

`src/testutils/` contains \Gromacs-specific shared test code.  This includes
a few parts:
 - Simple framework for building tests that check the results against reference
   data that is generated by the same test code.  When the test is first
   executed, `--ref-data create` can be passed on command line to create the
   reference data.  On later executions, the tests read the reference data and
   fail if the results are not the same.  It is possible to update existing
   reference data with `--ref-data update`.
   The reference data is stored in XML files under
   `src/gromacs/`<em>module</em>`/tests/refdata/`.  This part of the framework
   depends on `libxml2`.  For inspecting the reference data in a browser, there
   are XSLT stylesheets that transform the XML files into HTML.  Such custom
   transformations need to be written for each type of test if the output is
   not easy to check otherwise.
   The current reference data functionality is quite basic, but it can be extended
   if/when more control over, e.g., comparison tolerances is needed.
   See gmx::test::TestReferenceData for documentation and existing tests
   (e.g., the selection unit tests) for examples of how to use it.
 - CMake macros for declaring test binaries.  These take care of providing the
   %main() method for the test executables and initializing the other parts of
   the framework, so that the test code in modules can focus on the actual
   tests.
   See `src/testutils/TestMacros.cmake` and existing CMake code for examples
   how to use them.
 - Generic test fixtures and helper classes.  Functionality here includes
   locating test input files from the source directory and constructing
   temporary files (gmx::test::TestFileManager), adding custom command line
   options to the test binary (testoptions.h), some custom test assertions
   for better exception and floating-point handling (testasserts.h), utilities
   for constructing command line argument arrays (gmx::test::CommandLine) and
   test fixtures for tests that need to test long strings for correctness
   (gmx::test::StringTestBase) and for tests that execute legacy code where
   stdin reading etc. cannot be easily mocked
   (gmx::test::IntegrationTestFixture).
 - Some classes and functions to support the above.  This code is for internal
   use by the CMake machinery to build and set up the test binaries, and to
   customize Google Test to suit our environment.

In addition to `src/testutils/`, some of the module test directories may
provide reusable test code that is used in higher-level tests.  For example,
the \ref module_analysisdata module provides test fixtures, a mock
implementation for gmx::AnalysisDataModuleInterface, and some helper classes
that are also used in \ref module_trajectoryanalysis module tests.
These cases are handled using CMake object libraries that are linked to all the
test binaries that need them.

Getting started with new tests
==============================

To start working with new tests, you should first read [Google Test][]
documentation to get a basic understanding of the testing framework, and read
the above description to understand how the tests are organized in \Gromacs.

Writing a basic test is straightforward, and you can look at existing tests for
examples.  The existing tests have a varying level of complexity, so here are
some pointers to find tests that use certain functionality:
 - `src/gromacs/utility/tests/stringutil.cpp` contains very simple tests for
   functions (e.g., for gmx::formatString() and gmx::replaceAll()).  These do
   not use any fancy functionality, only plain Google Test assertions.
   The only thing required for these tests is the `TEST()` macro and the block
   following it, plus headers required to make them compile.
 - The same file contains also simple tests using the reference framework to
   check line wrapping (the tests for gmx::TextLineWrapper).  The test fixture
   for these tests is in `src/testutils/stringtest.h`/`.cpp`.  The string test
   fixture also demonstrates how to add a custom command line option to the
   test binary to influence the test execution.
 - The \ref module_selection module tests contain more complex use of the
   reference framework.  This is the code the reference framework was
   originally written for.
   `src/gromacs/selection/tests/selectioncollection.cpp` is the main file to
   look at.
 - For more complex tests that do not use the reference framework, but instead
   compute the reference values in code, you can look at
   `src/gromacs/selection/tests/nbsearch.cpp`.
 - For complex tests with mock-up classes and the reference framework, you can
   look at \ref module_analysisdata tests.


[Google Test]: http://code.google.com/p/googletest/
[Google Test Primer]: http://code.google.com/p/googletest/wiki/V1_7_Primer
[Google Mock]: http://code.google.com/p/googlemock/
